name: Build app image and publish on Dockerhub

on:
  workflow_dispatch:

jobs:
  build_and_push_image_to_dockerhub:
    runs-on: ubuntu-latest
    permissions:
      security-events: write   # ← Essa linha resolve o erro de upload
      contents: read           # Já é padrão, mas bom manter explícito
      # actions: read          # Opcional, só se precisar
    strategy:
      fail-fast: false
      matrix:
        python-version: [ '3.10' ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }} # Use the secret you created

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2


      - name: Run Trivy vulnerability scanner on repository
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: . # Scans the current directory (root of the repo)
          format: 'github' # Format output for GitHub Advanced Security
          output: 'trivy-results.sarif' # Save results to a SARIF file
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,config,secret,license' # Scan for vulnerabilities, configs, secrets, and licenses

      - name: Build, tag  and push Docker image to Dockerhub (amd64)
        run: |
          # Derive release tag (strip leading 'v' if present) and export to subsequent steps
          LATEST_RELEASE_TAG=$(echo "$GITHUB_REF_NAME" | sed 's/^v//')
          echo "LATEST_RELEASE_TAG=$LATEST_RELEASE_TAG" >> $GITHUB_ENV

          # Buildx setup and push directly to the ECR repository using fully-qualified image name
          docker buildx create --use
          IMAGE_URI="${{ secrets.DOCKER_USERNAME }}/testing:${LATEST_RELEASE_TAG}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

          docker buildx build --platform linux/amd64 -t "$IMAGE_URI" --push .

      - name: Run Trivy vulnerability scanner on Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_URI }}
          format: 'sarif'
          output: 'trivy-repo-results.sarif'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,config,secret,license' # Scan for vulnerabilities, configs, secrets, and licenses

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-repo-results.sarif'

      - name: (No-op) Image already pushed during build
        run: |
          echo "Image was pushed during the build step to $IMAGE_URI"
